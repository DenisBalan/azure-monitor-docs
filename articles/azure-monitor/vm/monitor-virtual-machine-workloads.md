---
title: Monitor Azure virtual machines with Azure Monitor - Workloads
description: Describes how to monitor the guest workloads of virtual machines in Azure Monitor.
ms.service:  azure-monitor
ms.topic: conceptual
author: bwren
ms.author: bwren
ms.date: 06/02/2021

---

# Monitoring virtual machines with Azure Monitor - Workloads
This article is part of the [Monitoring virtual machines and their workloads in Azure Monitor](monitor-virtual-machine.md). It describes how to monitor workloads that are running on the guest operating systems of your virtual machines. This includes details on analyzing and alerting on different sources of data on your virtual machines.

> [!NOTE]
> The requirements for monitoring logic to implement for your workloads will depend on your particular set of workloads and business requirements. 
These are data sources commonly used by management packs in System Center Operations Manager which you may already be using for monitoring your applications. See [Converting management packs](monitor-virtual-machine-scom.md) for a strategy on converting management pack logic in Azure Monitor using the details in this article.

### Synthetic transactions
A synthetic transaction connects to an application or service running on the VM simulating a user connection or actual user traffic. If the application is available, then you can assume that the machine is running properly . Application monitoring is provided by Application insights 
This only works for applications that are accessible from the internet. For internal applications, you must open a firewall to allow access from specific Microsoft URLs performing the test, or use an alternate monitoring solution such as SCOM.

[URL test](../app/monitor-web-app-availability.md) – Ensures that HTTP is available and returning a web page.
[Multistep test](../app/availability-multistep.md) – Simulates a user session.


## Configure additional data collection
VM insights collects only performance data from the guest operating system of enabled machines. You can enable the collection of additional performance data, events, and other monitoring data from the agent by configuring the Log Analytics workspace. It only needs to be configured once, since any agent connecting to the workspace will automatically download the configuration and immediately start collecting the defined data. 

> [!NOTE]
> You cannot selectively configure data collection for different machines. All machines connected to the workspace will use the configuration for that workspace.



> [!IMPORTANT]
> Be careful to only collect the data that you require since there are costs associated with any data collected in your workspace. The data that you collect should only support particular analysis and alerting scenarios 

See [Agent data sources in Azure Monitor](../agents/agent-data-sources.md) for a list of the data sources available and details on configuring them. 

## Windows or Syslog event
Windows events or Syslog events on Linux computers generated by your application or the guest operating system. You can create an alert when a Windows or Syslog event is created. You can alert as soon as a single event is found or wait for a series of matching events within a particular time window.


Configure Log Analytics workspace to collect [Windows events](../agents/data-sources-windows-events.md) or [Syslog events](../agents/data-sources-windows-events.md). There is a cost for the ingestion and retention of this data in the workspace.

Windows events are stored in the [Event](/azure/azure-monitor/reference/tables/event) table and Syslog events in the [Syslog](/azure/azure-monitor/reference/tables/syslog) table in the Log Analytics workspace.


### Sample log queries

```kusto
//Count the number of events by computer event log, and event type
Event
| summarize count() by Computer, EventLog, EventLevelName
| sort by Computer, EventLog, EventLevelName
```

```kusto
//Count the number of events by computer event log, and event ID
Event
| summarize count() by Computer, EventLog, EventLevelName
| sort by Computer, EventLog, EventLevelName
```


### Sample alert rules
The following sample creates an alert when a specific Windows event is created. It uses a metric measurement alert rule to create a separate alert for each computer.


| Property | Value| Notes |
|:---|:---|:---|
| Name | Server Virtual Disk Redundancy Lost - System Event 2123 ||
| Scope | Log Analytics Workspace ||
| Signal Type | Logs ||
| Signal Name | Custom Log Search ||
| Search Query | `Event | where EventID == 123 | summarize AggregatedValue = count() by Computer, bin(TimeGenerated, 15m)`| Change to a query using `Syslog` table for Syslog alert. |
| Based on | Metric measurement | Ensures a separate alert for each machine. |
| Threshold | Greater than 0 | |
| Trigger | Breaches greater than 0 | Increase this value to require multiple consecutive events.  |
| Period | 15 | Defines the time window for the events that are processed. The query will only consider the events created over the previous hour.  |
| Frequency | 15 minutes | Change this value to run the alert rule more frequently with an increase in cost. | 

## Custom performance counters
Performance counters created by workflows or the guest operating system that aren't collected by VM insights. VM insights doesn't currently allow you to specify which performance counters should be selected. 

Configure Log Analytics workspace to collect performance data](../agents/data-sources-windows-events.md). There is a cost for the ingestion and retention of this data in the workspace. Be careful to not collect performance data that's already being collected by VM insights. VM insights collects the most common set of counters at a frequency of once per minute. Only configure performance counters to be collected by the workspace if you want to collect counters not already collected by VM insights or if you have existing queries using performance data.

Performance data configured by the workspace are stored in the [Perf](/azure/azure-monitor/reference/tables/perf) table. This has a different structure than the [InsightsMetrics](/azure/azure-monitor/reference/tables/insightsmetrics) table used by VM insights.

### Sample log queries

See [Log queries with Performance records](../../agents/data-sources-performance-counters.md#log-queries-with-performance-records) For example of log queries using custom performance counters.

### Sample alerts

**Alert on maximum value of a counter**

```kusto
Perf 
| where CounterName == "My Counter" 
| summarize AggregatedValue = max(CounterValue) by Computer
```

**Alert on average value of a counter**

```kusto
Perf 
| where CounterName == "My Counter" 
| summarize AggregatedValue = avg(CounterValue) by Computer
```

## Text logs
Events written to a text log stored on the virtual machine. 

Define a [custom log](../agents/data-sources-custom-logs.md) in the Log Analytics workspace. You define the location of the text log and its detailed configuration. There is a cost for the ingestion and retention of this data in the workspace.

Events from the text log are stored in a table named similar to **MyTable_CL**.  Define the name and structure of the log when you configure it. 

### Sample log queries

### Sample alert rule


## IIS logs
Events logged by IIS on the virtual machine.

Configure Log Analytics workspace to collect [IIS logs](../agents/data-sources-iis.md). There is a cost for the ingestion and retention of this data in the workspace.

Records from the IIS log are stored in the [W3CIISLog](/azure/azure-monitor/reference/tables/w3ciislog) table in the Log Analytics workspace.

### Sample alert rule



## Service or deamon
Monitor the status of a Windows service or Linux daemon and create an alert when it stops. 

To monitor the status of a service or daemon, enable the [Change Tracking and Inventory](../../automation/change-tracking/overview.md) solution in [Azure Automation(../../automation/overview.md). Azure Monitor alone can't monitor the status a service or daemon, There are some possible methods such as looking for events in the Windows event log, but this is unreliable. You could also look for the process associated with the service running on the machine from the [VMProcess](/azure/azure-monitor/reference/tables/vmprocess) table, but this only updated every hour which is not typically sufficient for alerting.

> [!NOTE]
> The Change Tracking and Analysis solution is different the [Change Analysis](vminsights-change-analysis.md) feature in VM insights. This feature is in public preview and not yet included in this scenario. 

See [Enable Change Tracking and Inventory](../../automation/change-tracking/overview.md#enable-change-tracking-and-inventory) for different options to enable the Change Tracking solution on your virtual machines. This includes methods to configure virtual machines at scale. You will have to [create an Azure Automation account](../../automation/automation-quickstart-create-account.md).

When you enable Change Tracking and Inventory, two new tables are created in your Log Analytics workspace.

| Table | Description |
|:---|:---|
| [ConfigurationChange](/azure/azure-monitor/reference/tables/configurationdata) | Changes to in-guest configuration data. |
| [ConfigurationData](/azure/azure-monitor/reference/tables/configurationdata) | Last reported state for in-guest configuration data. |


### Sample log queries

### Alert rule samples


**Alert when a specific service stops**


```kusto
ConfigurationData
| where SvcName == "W3SVC" 
| where SvcState == "Stopped"
| where ConfigDataType == "WindowsServices"
| where SvcStartupType == "Auto"
| summarize AggregatedValue = count() by Computer, SvcName, SvcDisplayName, SvcState, bin(TimeGenerated, 15m)
```

**Alert when one of a set of services stops**


```kusto
let services = dynamic(["omskd","cshost","schedule","wuauserv","heathservice","efs","wsusservice","SrmSvc","CertSvc","wmsvc","vpxd","winmgmt","netman","smsexec","w3svc","sms_site_vss_writer","ccmexe","spooler","eventsystem","netlogon","kdc","ntds","lsmserv","gpsvc","dns","dfsr","dfs","dhcp","DNSCache","dmserver","messenger","w32time","plugplay","rpcss","lanmanserver","lmhosts","eventlog","lanmanworkstation","wnirm","mpssvc","dhcpserver","VSS","ClusSvc","MSExchangeTransport","MSExchangeIS"]);
ConfigurationData
| where ConfigDataType == "WindowsServices"
| where SvcStartupType == "Auto"
| where SvcName in (services)
| where SvcState == "Stopped"
| project TimeGenerated, Computer, SvcName, SvcDisplayName, SvcState
| summarize AggregatedValue = count() by Computer, SvcName, SvcDisplayName, SvcState, bin(TimeGenerated, 15m)
```



## Port monitoring
Port monitoring verifies that a machine is listening on a particular port. There are two potential strategies for port monitoring. 

### Dependency agent tables
Use the [VMConnection](/azure/azure-monitor/reference/tables/vmconnection) and [VMBoundPort](/azure/azure-monitor/reference/tables/vmboundport) to analyze ports and connections on the machine. – Analysis of network connection data with Azure Monitor for virtual machines
The VMBoundPort table is updated every minute with each process running on the computer and the port is listening on. You could create a log query alert  similar to the missing heartbeat alert to find processes that have stopped or to alert when the machine isn’t listening on a particular port. 

```kusto
// Review the count of ports open on your VMs, which is useful when assessing which VMs configuration and security vulnerabilities.
VMBoundPort
| where Ip != "127.0.0.1"
| summarize by Computer, Machine, Port, Protocol
| summarize OpenPorts=count() by Computer, Machine
| order by OpenPorts desc
```


```kusto
// List the bound ports on your VMs, which is useful when assessing which VMs configuration and security vulnerabilities.
VMBoundPort
| distinct Computer, Port, ProcessName
```




```kusto
// Analyze network activity by port to determine how your application or service is configured.
VMBoundPort
| where Ip != "127.0.0.1"
| summarize BytesSent=sum(BytesSent), BytesReceived=sum(BytesReceived), LinksEstablished=sum(LinksEstablished), LinksTerminated=sum(LinksTerminated), arg_max(TimeGenerated, LinksLive) by Machine, Computer, ProcessName, Ip, Port, IsWildcardBind
| project-away TimeGenerated
| order by Machine, Computer, Port, Ip, ProcessName
```

```kusto
//Bytes sent and received trends for your VMs.
VMConnection
| summarize sum(BytesSent), sum(BytesReceived) by bin(TimeGenerated,1hr), Computer
| order by Computer desc
//| limit 5000
| render timechart
```

```kusto
// Connection failures over time, to determine if the failure rate is stable or changing.
VMConnection
| where Computer == <replace this with a computer name, e.g. ‘acme-demo’>
| extend bythehour = datetime_part("hour", TimeGenerated)
| project bythehour, LinksFailed
| summarize failCount = count() by bythehour
| sort by bythehour asc
| render timechart
```

```kusto
// Link status trends, to analyze the behavior and connection status of a machine.
VMConnection
| where Computer == <replace this with a computer name, e.g. ‘acme-demo’>
| summarize  dcount(LinksEstablished), dcount(LinksLive), dcount(LinksFailed), dcount(LinksTerminated) by bin(TimeGenerated, 1h)
| render timechart
```

### Connection Manager
The [Connection Monitor](../../network-watcher/connection-monitor-overview.md) feature of [Network Watcher](../../network-watcher/network-watcher-monitoring-overview.md) can be used to test connections to a port on a virtual machine. This verifies that the machine is listening on the port and that it’s accessible on the network. 
Connection Manager requires the Network Watcher extension on client machine initiating the test. It does not need to be installed on the machine being tested. See [Tutorial - Monitor network communication using the Azure portal](../../network-watcher/connection-monitor.md) for details.

There is an additional cost for Connection Manager. See [Network Watcher pricing](https://azure.microsoft.com/pricing/details/network-watcher/) for details.

Create a metric alert rule to create an alert from Connection Manager, see [Generate alerts](../../network-watcher/connection-monitor.md#generate-alerts)



## Next steps

* [Learn how to analyze data in Azure Monitor logs using log queries.](../logs/get-started-queries.md)
* [Learn about alerts using metrics and logs in Azure Monitor.](../alerts/alerts-overview.md)